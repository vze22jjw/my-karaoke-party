# Automated Deployment (GitHub + ECR + Portainer) / Deploy Automatizado

<details open>
<summary>ðŸ‡¬ðŸ‡§ English</summary>

This project uses a fully automated CI/CD pipeline to build, publish, and deploy the application using GitHub Actions, AWS Elastic Container Registry (ECR) Public, and Portainer.

## ðŸ”„ The Workflow
1.  **Trigger:** You push code to the `main` branch (or merge a PR).
2.  **Build:** GitHub Actions builds the Docker image (multi-arch: `amd64` & `arm64`).
3.  **Push:** The image is pushed to your public AWS ECR repository.
4.  **Deploy:** GitHub Actions calls a Webhook in your Portainer instance.
5.  **Update:** Portainer pulls the new image (`app-latest`) and recreates the container automatically.

## ðŸ› ï¸ GitHub Actions

### 1. Build & Push (`docker-build-push.yml`)
* **Triggers:**
    * Push to `main`.
    * Pull Request merged to `main`.
    * Monthly schedule (to keep images fresh).
    * Manual dispatch.
* **Tags:**
    * `app-latest`: The mutable tag used by Portainer for deployment.
    * `app-v0.0.2-{commit_hash}`: Immutable tag for version history and rollbacks.
* **Deployment:**
    * After a successful push, it executes a `curl` command to the `PORTAINER_WEBHOOK_URL`.

### 2. Cleanup (`prune-ecr-images.yml`)
* **Schedule:** Runs every Sunday at 3:00 AM UTC.
* **Logic:**
    * Keeps the `latest` tag.
    * Keeps the **10 most recent** timestamps.
    * Deletes all other old images to save space and reduce clutter in the public gallery.

## ðŸ”‘ Setup Requirements

### GitHub Secrets
Go to **Settings > Secrets and variables > Actions** in your repo and add:

| Secret | Description |
| :--- | :--- |
| `AWS_ACCESS_KEY_ID` | IAM User with permissions to push/delete in ECR Public. |
| `AWS_SECRET_ACCESS_KEY` | The secret key for the IAM User. |
| `PORTAINER_WEBHOOK_URL` | The URL generated by Portainer (see below). |

### GitHub Variables
Go to **Settings > Secrets and variables > Actions > Variables**:

| Variable | Description |
| :--- | :--- |
| `ECR_REGISTRY` | E.g., `public.ecr.aws/x1y2z3` |
| `ECR_REPOSITORY` | E.g., `my-karaoke-party` |

### Portainer Setup
1.  Create a **Stack** or **Service** using the image: `public.ecr.aws/YOUR_ID/my-karaoke-party:app-latest`.
2.  Enable **"Service Webhook"** in the service settings.
3.  Copy the generated Webhook URL.
4.  Paste this URL into the `PORTAINER_WEBHOOK_URL` GitHub Secret.

</details>

<details>
<summary>ðŸ‡§ðŸ‡· PortuguÃªs</summary>

Este projeto utiliza um pipeline CI/CD totalmente automatizado para construir, publicar e implantar o aplicativo usando GitHub Actions, AWS Elastic Container Registry (ECR) Public e Portainer.

## ðŸ”„ O Fluxo de Trabalho
1.  **Gatilho:** VocÃª envia cÃ³digo para a branch `main` (ou mescla um PR).
2.  **Build:** O GitHub Actions constrÃ³i a imagem Docker (multi-arquitetura: `amd64` e `arm64`).
3.  **Push:** A imagem Ã© enviada para o seu repositÃ³rio pÃºblico no AWS ECR.
4.  **Deploy:** O GitHub Actions chama um Webhook na sua instÃ¢ncia do Portainer.
5.  **AtualizaÃ§Ã£o:** O Portainer baixa a nova imagem (`app-latest`) e recria o container automaticamente.

## ðŸ› ï¸ GitHub Actions

### 1. Build & Push (`docker-build-push.yml`)
* **Gatilhos:**
    * Push na `main`.
    * Pull Request mesclado na `main`.
    * Agendamento mensal (para manter imagens atualizadas).
    * Disparo manual.
* **Tags:**
    * `app-latest`: Tag mutÃ¡vel usada pelo Portainer para o deploy.
    * `app-v0.0.2-{commit_hash}`: Tag imutÃ¡vel para histÃ³rico de versÃµes e rollbacks.
* **ImplantaÃ§Ã£o:**
    * ApÃ³s um envio bem-sucedido, executa um comando `curl` para a `PORTAINER_WEBHOOK_URL`.

### 2. Limpeza (`prune-ecr-images.yml`)
* **Agendamento:** Roda todo domingo Ã s 03:00 AM UTC.
* **LÃ³gica:**
    * MantÃ©m a tag `latest`.
    * MantÃ©m as **10 imagens mais recentes** (por data de envio).
    * Exclui todas as outras imagens antigas para economizar espaÃ§o e manter a galeria pÃºblica organizada.

## ðŸ”‘ Requisitos de ConfiguraÃ§Ã£o

### GitHub Secrets (Segredos)
VÃ¡ em **Settings > Secrets and variables > Actions** no seu repositÃ³rio e adicione:

| Segredo | DescriÃ§Ã£o |
| :--- | :--- |
| `AWS_ACCESS_KEY_ID` | UsuÃ¡rio IAM com permissÃµes para push/delete no ECR Public. |
| `AWS_SECRET_ACCESS_KEY` | A chave secreta do UsuÃ¡rio IAM. |
| `PORTAINER_WEBHOOK_URL` | A URL gerada pelo Portainer (veja abaixo). |

### GitHub Variables (VariÃ¡veis)
VÃ¡ em **Settings > Secrets and variables > Actions > Variables**:

| VariÃ¡vel | DescriÃ§Ã£o |
| :--- | :--- |
| `ECR_REGISTRY` | Ex: `public.ecr.aws/x1y2z3` |
| `ECR_REPOSITORY` | Ex: `my-karaoke-party` |

### ConfiguraÃ§Ã£o do Portainer
1.  Crie uma **Stack** ou **ServiÃ§o** usando a imagem: `public.ecr.aws/SEU_ID/my-karaoke-party:app-latest`.
2.  Habilite **"Service Webhook"** nas configuraÃ§Ãµes do serviÃ§o.
3.  Copie a URL do Webhook gerada.
4.  Cole esta URL no segredo `PORTAINER_WEBHOOK_URL` do GitHub.

</details>
